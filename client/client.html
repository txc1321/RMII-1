<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Lister</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="/style.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">
    //TODO:
    // - Due date sorting bug
    // - Check server codes are working
    //    -200, 201, 204, 400, 404, 500(if required)
    // - HEAD support
    // - GET with parameters
    // - Fix for..in loops
    // - Comment code
    // --- Extra ---
    // - animation
    // - Cookies/same user
    const parseJSON = (xhr, content) => {
      let removeTask;
      if (xhr.response) {
        const obj = JSON.parse(xhr.response);

        if (obj.message) {
          console.dir(obj.message);
        }

        if (obj.tasks) {
          while (content.firstChild) {
            content.removeChild(content.firstChild);
          }
          const taskList = document.createElement('div');
          taskList.className = "taskList";

          for (let task in obj.tasks) {
            const taskBox = document.createElement('div');
            taskBox.className = "taskBox";
            taskBox.id = obj.tasks[task].task;
            taskList.appendChild(taskBox);

            const button = document.createElement('BUTTON');
            button.className = "taskButton";

            const style = document.querySelector('#styleButton').value;
            if (style === "Light Mode") {
              button.classList.add('btn', 'btn-outline-success', 'border', 'border-light');
            } else {
              button.classList.add('btn', 'btn-outline-primary', 'border', 'border-dark');
            }

            button.addEventListener('click', removeTask = () => {
              delete obj.tasks[button.parentNode.id];
              postDelete('POST', '/deleteTask', button.parentNode.id);
              button.parentNode.remove();
            });
            taskBox.appendChild(button);

            const taskText = document.createElement('span');
            taskText.textContent = obj.tasks[task].task + " | Due: " + obj.tasks[task].date + " " + obj.tasks[task].time;
            taskBox.appendChild(taskText);
          }
          content.appendChild(taskList);

          console.dir(JSON.stringify(obj));
        }
      }
    };

    const handleResponse = (xhr) => {
      const content = document.querySelector('#content');
      parseJSON(xhr, content);
    };

    const sendPost = (e, taskForm) => {
      const taskAction = taskForm.getAttribute('action');
      const taskMethod = taskForm.getAttribute('method');

      const taskField = taskForm.querySelector('#taskField');
      const dateField = taskForm.querySelector('#dateField');
      const timeField = taskForm.querySelector('#timeField');

      const xhr = new XMLHttpRequest();
      xhr.open(taskMethod, taskAction);

      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader('Accept', 'application/json');

      xhr.onload = () => handleResponse(xhr);

      const formData = `task=${taskField.value}&date=${dateField.value}&time=${timeField.value}`;

      xhr.send(formData);

      e.preventDefault();
      return false;
    };

    const postDelete = (method, url, key) => {
      const xhr = new XMLHttpRequest();
      xhr.open(method, url);

      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader('Accept', 'application/json');

      const deleteData = `task=${key}`;

      xhr.onload = () => handleResponse(xhr);
      xhr.send(deleteData);
    };

    const postOrder =  (method, url, value) => {
      const xhr = new XMLHttpRequest();
      xhr.open(method, url);

      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader('Accept', 'application/json');

      const orderData = `order=${value}`;

      xhr.onload = () => handleResponse(xhr);
      xhr.send(orderData);
    };

    const sendAjax = (url, method) => {
      const xhr = new XMLHttpRequest();
      xhr.open(method, url);
      xhr.setRequestHeader('Accept', 'application/json');
      xhr.onload = () => handleResponse(xhr);
      xhr.send();
    };

    const init = () => {
      const taskForm = document.querySelector('#taskForm');
      const addTask = (e) => {
        sendPost(e, taskForm);
        sendAjax('/getTasks', 'GET');
      };

      taskForm.addEventListener('submit', addTask);

      const createSortButton = document.querySelector('#dateCreated');
      const dateSortButton = document.querySelector('#dateDue');

      const handleSort = (e) => {
        const target = e.target;
        if(target.id === "dateCreated"){
          postOrder('POST', '/orderTasks', 0);
        }
        else{
          postOrder('POST', '/orderTasks', 1);
        }
      };

      dateSortButton.addEventListener('click', handleSort);
      createSortButton.addEventListener('click', handleSort);

      const inputs = document.querySelectorAll('.form-control');
      const inputTags = document.querySelectorAll('.input-group-text');
      const styleButton = document.querySelector('#styleButton');

      let style = "Dark Mode";

      styleButton.value = style;

      const changeStyle = (e) => {
        const buttons = document.querySelectorAll('.btn');

        if(styleButton.value === "Light Mode"){
          document.body.style.backgroundColor = '#FFFFFF';
          document.body.style.color = '#000000';

          for(let i = 0; i < buttons.length; i++){
            if(buttons[i].id === "dateLabel"){
              buttons[i].classList.remove("border-light");
              buttons[i].classList.add("border-dark");
              buttons[i].style.color ='#000000';
            }
            else if(buttons[i].classList.contains("taskButton")){
              buttons[i].classList.remove("btn-outline-success");
              buttons[i].classList.add("btn-outline-primary");
              buttons[i].classList.remove("border-light");
              buttons[i].classList.add("border-dark");
            }
            else{
              buttons[i].classList.remove("btn-success");
              buttons[i].classList.add("btn-primary");
            }
          }

          for(let i = 0; i < inputs.length; i++){
            inputs[i].style.backgroundColor = '#FFFFFF';
            inputs[i].style.color ='#495057';
            inputTags[i].style.backgroundColor = '#E9ECEF';
            inputTags[i].style.color = '#495057'
          }

          style = "Dark Mode";
          styleButton.value = style;
        }
        else{
          document.body.style.backgroundColor = '#2b2b2b';
          document.body.style.color = '#bbbbbb';

          for(let i = 0; i < buttons.length; i++){
            if(buttons[i].id === "dateLabel"){
              buttons[i].classList.remove("border-dark");
              buttons[i].classList.add("border-light");
              buttons[i].style.color ='#FFFFFF';
            }
            else if(buttons[i].classList.contains("taskButton")){
              buttons[i].classList.remove("btn-outline-primary");
              buttons[i].classList.add("btn-outline-success");
              buttons[i].classList.remove("border-dark");
              buttons[i].classList.add("border-light");
            }
            else{
              buttons[i].classList.remove("btn-primary");
              buttons[i].classList.add("btn-success");
            }
          }

          for(let i = 0; i < inputs.length; i++){
            inputs[i].style.backgroundColor = '#595b5d';
            inputs[i].style.color ='#bbbbbb';
            inputTags[i].style.backgroundColor = '#323232';
            inputTags[i].style.color = '#bbbbbb'
          }

          style = "Light Mode";
          styleButton.value = style;
        }
      };

      styleButton.addEventListener('click', changeStyle);
    };

    window.onload = init;
  </script>
</head>
<body>
  <section id="top">
    <h3 id="title">Lister</h3>
    <form id="taskForm"action="/addTask" method="post">
      <div class="w-25 input-group mb-3 mx-auto">
        <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon1">Task:</span>
        </div>
        <input id="taskField" class="form-control" type="text" name="task" />
      </div>

      <div class="w-25 input-group mb-3 mx-auto">
        <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon2">Due Date:</span>
        </div>
        <input id="dateField" class="form-control" type="date" name="date" step="1"/>
      </div>

      <div class="w-25 input-group mb-3 mx-auto">
        <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon2">Time:</span>
        </div>
        <input id="timeField" class="form-control" type="time" name="time" step="1"/>
      </div>

      <input id="taskSubmit" class="btn btn-primary" type="submit" value="Add Task" />

      <div id="sortButtons" class="btn-group btn-group-toggle" data-toggle="buttons">
        <label class="btn border-dark" id="dateLabel" disabled>
          <input type="radio" name="options" autocomplete="off"> Sort By:
        </label>
        <label class="btn btn-primary active" id="dateCreated">
          <input type="radio" name="options" autocomplete="off" checked> Date Created
        </label>
        <label class="btn btn-primary" id="dateDue">
          <input type="radio" name="options"  autocomplete="off"> Date Due
        </label>
      </div>

      <input id="styleButton" class="btn btn-primary" type="button" value="" />
    </form>
  </section>
  <section id="content">
  </section>

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>